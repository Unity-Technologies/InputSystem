{% metadata_file .yamato/draft-config.metadata %}
---

{% for editor in editors %}
{% for editor_platform in editor_platforms %}
draft_editor_playmode_andisolation_{{ editor_platform.name }}_{{ editor.version }}:
  name : "Editor Playmode (And Isolation) Tests [{{ editor_platform.name }}, {{ editor.version }}]"
  agent:
    type: {{ editor_platform.type }}
    image: {{ editor_platform.image }}
    flavor: {{ editor_platform.flavor}}
  commands:
    # Install any extra .NET SDK's on images that don't have them, "docfx metadata" requires a .NET SDK to work.
{% if editor_platform.netinstall %}
    - {{ editor_platform.netinstall }}
{% endif %}
    # Get latest version of doctools package. Automatically makes the documentation tests in APIVerification go live.
    - git clone git@github.cds.internal.unity3d.com:unity/com.unity.package-manager-doctools.git Packages/com.unity.package-manager-doctools
    # We keep the samples in Assets/ as they otherwise won't get imported and you can't
    # really work with them. Move them into the package for when we run upm-ci here.
    - mv ./Assets/Samples ./Packages/com.unity.inputsystem
    - mv ./Assets/Samples.meta ./Packages/com.unity.inputsystem
    - npm install upm-ci-utils@{{ upm_ci_pinned_stable_version }} --registry {{ upm_ci_install_registry }} -g
    - upm-ci package pack --package-path ./Packages/com.unity.inputsystem/
    # Run upm-ci verification tests as well as tests contained in the package.
    - upm-ci package test --package-path ./Packages/com.unity.inputsystem/ -u {{ editor.version }}
    # ADBv2 on 2019.4 causes the test runner to not start on initial import when the
    # samples are in the package. Move the samples back into the project.
    - mv ./Packages/com.unity.inputsystem/Samples ./Assets
    - mv ./Packages/com.unity.inputsystem/Samples.meta ./Assets
    # Now run our full test suite that sits in Assets/Tests by running UTR on our project.
    - upm-ci~/tools/utr/utr --testproject . --timeout=1200 --editor-location=.Editor --artifacts_path=upm-ci~/test-results/isolation-com.unity.inputsystem.tests --suite=playmode --api-profile=NET_4_6 --stdout-filter=minimal --report-performance-data --performance-project-id=InputSystem
  artifacts:
    UTR_Editor_Playmode_AndPack.zip:
      paths:
        - "upm-ci~/test-results/**/*"
{% endfor %}
{% endfor %}


{% for editor in editors %}
{% for editor_platform in editor_platforms %}
draft_editor_playmode_{{ editor_platform.name }}_{{ editor.version }}:
  name : "Editor Playmode Tests [{{ editor_platform.name }}, {{ editor.version }}]"
  agent:
    type: {{ editor_platform.type }}
    image: {{ editor_platform.image }}
    flavor: {{ editor_platform.flavor}}
  commands:
    # Install any extra .NET SDK's on images that don't have them, "docfx metadata" requires a .NET SDK to work.
{% if editor_platform.netinstall %}
    - {{ editor_platform.netinstall }}
{% endif %}
    # Get latest version of doctools package. Automatically makes the documentation tests in APIVerification go live.
    - git clone git@github.cds.internal.unity3d.com:unity/com.unity.package-manager-doctools.git Packages/com.unity.package-manager-doctools
    - npm install upm-ci-utils@{{ upm_ci_pinned_stable_version }} --registry {{ upm_ci_install_registry }} -g
    - pip install unity-downloader-cli --index-url {{ unity_downloader_cli_registry }}
    - unity-downloader-cli -c editor -w -u {{ editor.version }}
    # Now run our full test suite that sits in Assets/Tests by running UTR on our project.
    - upm-ci~/tools/utr/utr --testproject . --timeout=1200 --editor-location=.Editor --artifacts_path=upm-ci~/test-results/isolation-com.unity.inputsystem.tests --suite=playmode --api-profile=NET_4_6 --stdout-filter=minimal --report-performance-data --performance-project-id=InputSystem
  dependencies:
    - .yamato/draft-upm-isolation.yml#draft_upm_isolation_{{ editor_platform.name }}_{{ editor.version }}
  artifacts:
    UTR_Editor_Playmode.zip:
      paths:
        - "upm-ci~/test-results/**/*"
{% endfor %}
{% endfor %}
