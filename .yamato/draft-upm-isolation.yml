{% metadata_file .yamato/draft-config.metadata %}
---

{% for editor in editors %}
{% for editor_platform in editor_platforms %}
draft_upm_isolation_andpack_{{ editor_platform.name }}_{{ editor.version }}:
  name : "UPM Isolation (And Pack) Tests [{{ editor_platform.name }}, {{ editor.version }}]"
  agent:
    type: {{ editor_platform.type }}
    image: {{ editor_platform.image }}
    flavor: {{ editor_platform.flavor}}
  commands:
    # We keep the samples in Assets/ as they otherwise won't get imported and you can't
    # really work with them. Move them into the package for when we run upm-ci here.
    - mv ./Assets/Samples ./Packages/com.unity.inputsystem
    - mv ./Assets/Samples.meta ./Packages/com.unity.inputsystem
    - npm install upm-ci-utils@{{ upm_ci_pinned_stable_version }} --registry {{ upm_ci_install_registry }} -g
    - upm-ci package pack --package-path ./Packages/com.unity.inputsystem/
    # Run upm-ci verification tests as well as tests contained in the package.
    - upm-ci package test --package-path ./Packages/com.unity.inputsystem/ -u {{ editor.version }}
  artifacts:
    UPM_Isolation_AndPack.zip:
      paths:
        - "upm-ci~/test-results/**/*"
{% endfor %}
{% endfor %}

{% for editor in editors %}
{% for editor_platform in editor_platforms %}
draft_upm_isolation_{{ editor_platform.name }}_{{ editor.version }}:
  name : "UPM Isolation Tests [{{ editor_platform.name }}, {{ editor.version }}]"
  agent:
    type: {{ editor_platform.type }}
    image: {{ editor_platform.image }}
    flavor: {{ editor_platform.flavor}}
  commands:
    - npm install upm-ci-utils@{{ upm_ci_pinned_stable_version }} --registry {{ upm_ci_install_registry }} -g
    # Run upm-ci verification tests as well as tests contained in the package.
    - upm-ci package test --package-path ./Packages/com.unity.inputsystem/ -u {{ editor.version }}
  dependencies:
    - .yamato/draft-upm-pack.yml#draft_pack_with_samples
  artifacts:
    UPM_Isolation.zip:
      paths:
        - "upm-ci~/test-results/**/*"
{% endfor %}
{% endfor %}
